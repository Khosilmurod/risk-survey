/**
 * Risk Survey Experiment - Main Implementation
 * A web-based behavioral research experiment measuring risk preferences
 * 
 * File Structure:
 * - Constructor & Initialization
 * - UI Generation Methods  
 * - Trial Management
 * - Data Collection & Export
 */

class RiskSurveyExperiment {
    constructor() {
        this.currentTrialIndex = 0;
        this.trials = [];
        this.attentionChecks = [];
        this.csvData = [];
        this.trialCounter = 1;
        this.currentTimer = null;
        this.experimentConfig = null;
        this.attentionCheckQuestions = null;
        this.subjectId = null;

        // Trial state
        this.currentChoice = null;
        this.currentConfidence = null;
        this.trialStartTime = null;
        this.pageEntryTime = null;
        this.barChoiceTime = null;
        this.sliderInteracted = false;
        
        // Session tracking
        this.sessionId = `ses_${new Date().toISOString().replace(/[-:]/g, '').substring(0, 15)}`;
        this.sessionStartTime = new Date().toISOString();
    }

    async init() {
        try {
            const response = await fetch('config.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const config = await response.json();
            this.experimentConfig = config.experimentConfig;
            this.attentionCheckQuestions = config.attentionCheckQuestions;
            
            this.injectBarSizeCSS();
            await this.generateTrials();
            this.showWelcomePage();
        } catch (error) {
            console.error("Could not load experiment configuration:", error);
            this.showError("Could not load experiment configuration. Please contact the researcher.");
        }
    }

    injectBarSizeCSS() {
        // Remove any existing dynamic bar size styles
        const existingStyle = document.getElementById('dynamic-bar-sizes');
        if (existingStyle) {
            existingStyle.remove();
        }

        // Create new style element with configurable bar sizes
        const styleElement = document.createElement('style');
        styleElement.id = 'dynamic-bar-sizes';
        
        const largeWidth = this.experimentConfig.barSizes.large.width;
        const largeHeight = this.experimentConfig.barSizes.large.height;
        const smallWidth = this.experimentConfig.barSizes.small.width;
        const smallHeight = this.experimentConfig.barSizes.small.height;

        // Use config font sizes
        const largeFontSize = this.experimentConfig.fontSizes.large;
        const smallFontSize = this.experimentConfig.fontSizes.small;

        styleElement.textContent = `
            .size-large, .size-large.risk-bar, .size-large.safe-bar {
                width: ${largeWidth}px !important;
                height: ${largeHeight}px !important;
                font-size: ${largeFontSize}px !important;
            }
            
            .size-large .risk-bar-red, .size-large .risk-bar-blue {
                font-size: ${largeFontSize}px !important;
            }
            
            .size-large .option-label {
                font-size: ${largeFontSize}px !important;
            }
            
            .size-small, .size-small.risk-bar, .size-small.safe-bar {
                width: ${smallWidth}px !important;
                height: ${smallHeight}px !important;
                font-size: ${smallFontSize}px !important;
            }
            
            .size-small .risk-bar-red, .size-small .risk-bar-blue {
                font-size: ${smallFontSize}px !important;
            }
            
            .size-small .option-label {
                font-size: ${smallFontSize}px !important;
            }

            /* Mobile responsiveness for custom sizes */
            @media (max-width: 768px) {
                .size-large, .size-large.risk-bar, .size-large.safe-bar {
                    width: ${Math.max(60, largeWidth * 0.7)}px !important;
                    height: ${Math.max(120, largeHeight * 0.7)}px !important;
                    font-size: ${Math.max(8, largeFontSize * 0.8)}px !important;
                }
                
                .size-large .risk-bar-red, .size-large .risk-bar-blue {
                    font-size: ${Math.max(8, largeFontSize * 0.8)}px !important;
                }
                
                .size-large .option-label {
                    font-size: ${Math.max(8, largeFontSize * 0.8)}px !important;
                }
                
                .size-small, .size-small.risk-bar, .size-small.safe-bar {
                    width: ${Math.max(50, smallWidth * 0.7)}px !important;
                    height: ${Math.max(80, smallHeight * 0.7)}px !important;
                    font-size: ${Math.max(7, smallFontSize * 0.8)}px !important;
                }
                
                .size-small .risk-bar-red, .size-small .risk-bar-blue {
                    font-size: ${Math.max(7, smallFontSize * 0.8)}px !important;
                }
                
                .size-small .option-label {
                    font-size: ${Math.max(7, smallFontSize * 0.8)}px !important;
                }
            }

            @media (max-width: 480px) {
                .size-large, .size-large.risk-bar, .size-large.safe-bar {
                    width: ${Math.max(50, largeWidth * 0.6)}px !important;
                    height: ${Math.max(100, largeHeight * 0.6)}px !important;
                    font-size: ${Math.max(7, largeFontSize * 0.7)}px !important;
                }
                
                .size-large .risk-bar-red, .size-large .risk-bar-blue {
                    font-size: ${Math.max(7, largeFontSize * 0.7)}px !important;
                }
                
                .size-large .option-label {
                    font-size: ${Math.max(7, largeFontSize * 0.7)}px !important;
                }
                
                .size-small, .size-small.risk-bar, .size-small.safe-bar {
                    width: ${Math.max(40, smallWidth * 0.6)}px !important;
                    height: ${Math.max(70, smallHeight * 0.6)}px !important;
                    font-size: ${Math.max(6, smallFontSize * 0.7)}px !important;
                }
                
                .size-small .risk-bar-red, .size-small .risk-bar-blue {
                    font-size: ${Math.max(6, smallFontSize * 0.7)}px !important;
                }
                
                .size-small .option-label {
                    font-size: ${Math.max(6, smallFontSize * 0.7)}px !important;
                }
            }

            .option-label.option-label-top-small { font-size: ${smallFontSize}px !important; }
            .option-label.option-label-bottom-small { font-size: ${smallFontSize}px !important; }
            .option-label.option-label-top-medium { font-size: ${mediumFontSize}px !important; }
            .option-label.option-label-bottom-medium { font-size: ${mediumFontSize}px !important; }
            .option-label.option-label-top-large { font-size: ${largeFontSize}px !important; }
            .option-label.option-label-bottom-large { font-size: ${largeFontSize}px !important; }
        `;

        document.head.appendChild(styleElement);
        console.log(`Bar sizes configured - Large: ${largeWidth}x${largeHeight}px, Small: ${smallWidth}x${smallHeight}px`);
    }

    showError(message) {
        document.body.innerHTML = `
            <div class="main-container">
                <div class="instructions">
                    <h2>Error</h2>
                    <div style="border: 1px solid #e5e5e5; padding: 2rem; border-radius: 4px; margin: 2rem 0; background: #fafafa; color: red;">
                        <p>${message}</p>
                    </div>
                </div>
            </div>`;
    }

    // ================================
    // UI GENERATION METHODS
    // ================================

    showWelcomePage() {
        document.body.innerHTML = `
            <div class="main-container" style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
                <div style="text-align: center; max-width: 500px; margin: 0 auto; width: 100%;">
                    <h1 style="color: var(--text-primary); margin-bottom: 2rem;">Welcome to the Study</h1>
                    <p style="font-size: 18px; color: var(--text-secondary); margin-bottom: 3rem; line-height: 1.6;">
                        Thank you for participating in our decision-making research study.
                    </p>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 2rem; margin: 2rem 0; border-left: 4px solid var(--text-primary);">
                        <h3 style="margin-top: 0; color: var(--text-primary); margin-bottom: 1.5rem;">Please Enter Your Information</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label for="subject-id" style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary);">Subject ID:</label>
                            <input type="text" id="subject-id" placeholder="Enter your subject ID..." 
                                style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        
                        <div id="id-warning" style="color: var(--risk-red); font-weight: bold; margin-top: 10px; visibility: hidden;">
                            Please enter a valid subject ID to continue.
                        </div>
                    </div>
                    
                    <div style="margin-top: 3rem;">
                        <button id="continue-btn" class="next-button" onclick="experiment.validateAndContinue()" disabled>Continue</button>
                    </div>
                </div>
            </div>
        `;
        
        // Add event listener for subject ID input
        const subjectInput = document.getElementById('subject-id');
        const continueBtn = document.getElementById('continue-btn');
        const warning = document.getElementById('id-warning');
        
        subjectInput.addEventListener('input', () => {
            const value = subjectInput.value.trim();
            if (value.length > 0) {
                continueBtn.disabled = false;
                continueBtn.style.background = 'var(--text-primary)';
                continueBtn.style.cursor = 'pointer';
                warning.style.visibility = 'hidden';
            } else {
                continueBtn.disabled = true;
                continueBtn.style.background = 'var(--text-light)';
                continueBtn.style.cursor = 'not-allowed';
            }
        });
        
        // Allow Enter key to continue
        subjectInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !continueBtn.disabled) {
                this.validateAndContinue();
            }
        });
    }

    validateAndContinue() {
        const subjectInput = document.getElementById('subject-id');
        const warning = document.getElementById('id-warning');
        const subjectId = subjectInput.value.trim();
        
        if (subjectId.length === 0) {
            warning.style.visibility = 'visible';
            warning.textContent = 'Please enter a valid subject ID to continue.';
            return;
        }
        
        // Store the subject ID
        this.subjectId = subjectId;
        console.log(`Subject ID set to: ${this.subjectId}`);
        
        // Continue to instructions
        this.showInstructions();
    }

    showInstructions() {
        document.body.innerHTML = `
            <div class="main-container">
                                <div class="instructions" style="text-align: center;">
                    <h2>Decision-Making Task</h2>
                    <p style="font-size: 18px; color: var(--text-primary); margin-bottom: 2rem;">You will choose between <strong>risky</strong> and <strong>safe</strong> options to earn points.</p>
                    
                    <div style="display: flex; justify-content: space-around; align-items: flex-start; gap: 3rem; margin: 2rem 0; flex-wrap: wrap;">
                        
                        <div style="flex: 1; min-width: 300px; text-align: center;">
                            <h3 style="color: var(--risk-red); margin-bottom: 1rem;">üé≤ Risky Option</h3>
                            <div class="option" style="margin: 1rem auto;">
                                <div class="option-label" style="font-size: 20px; font-weight: bold; color: var(--text-primary);">200</div>
                                <div class="risk-bar size-small instruction-bar">
                                    <div class="risk-bar-red" style="height: 75%;">75%</div>
                                    <div class="risk-bar-blue" style="height: 25%;">25%</div>
                                </div>
                                <div class="option-label" style="font-size: 20px; font-weight: bold; color: var(--text-primary);">0</div>
                            </div>
                            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 1rem; line-height: 1.4;">
                                <strong>75% chance</strong> to win 200 points<br>
                                <strong>25% chance</strong> to win 0 points
                            </p>
                        </div>

                        <div style="flex: 1; min-width: 300px; text-align: center;">
                            <h3 style="color: var(--safe-gray); margin-bottom: 1rem;">üõ°Ô∏è Safe Option</h3>
                    <div class="option" style="margin: 1rem auto;">
                                <div class="option-label" style="font-size: 20px; font-weight: bold; color: var(--text-primary);">150</div>
                                <div class="safe-bar size-small instruction-bar">
                                    100%
                                </div>
                                <div class="option-label" style="visibility: hidden;">0</div>
                            </div>
                            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 1rem; line-height: 1.4;">
                                <strong>100% chance</strong> to win 150 points<br>
                                Guaranteed outcome
                            </p>
                        </div>
                        
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin: 2rem 0; border-left: 4px solid var(--text-primary);">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">üìã Your Task</h3>
                        <ol style="text-align: left; max-width: 600px; margin: 0 auto; line-height: 1.6;">
                            <li style="margin-bottom: 0.5rem;"><strong>Choose</strong> your preferred option by clicking on it</li>
                            <li style="margin-bottom: 0.5rem;"><strong>Rate your confidence</strong> (0-100) in your choice</li>
                            <li style="margin-bottom: 0.5rem;"><strong>Click Next</strong> to continue to the next choice</li>
                        </ol>
                        <p style="font-size: 14px; color: var(--text-secondary); margin-top: 1rem; font-style: italic;">
                            Make decisions as if they were real. You'll start with practice trials.
                        </p>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
                        <h3 style="margin-top: 0; color: #856404;">‚è±Ô∏è Important Timing Info</h3>
                        <p style="margin-bottom: 0; color: #856404; line-height: 1.5;">
                            You have <strong>8 seconds</strong> to make each choice. After selecting, rate your confidence (0-100) and click Next.
                        </p>
                    </div>
                    
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
                        <h3 style="margin-top: 0; color: #0c5460;">üéØ What to Expect</h3>
                        <ul style="margin-bottom: 0; color: #0c5460; line-height: 1.5; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <li><strong>5 practice trials</strong> to get familiar</li>
                            <li><strong>72 main trials</strong> with different choices</li>
                            <li>Some <strong>attention checks</strong> during the task</li>
                        </ul>
                    </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="next-button" onclick="experiment.startPractice()">Start</button>
                    </div>
                </div>
            </div>
        `;
    }

    // ================================
    // TRIAL GENERATION & MANAGEMENT
    // ================================

    async generateTrials() {
        try {
            // Load trials from CSV file
            const trialsData = await this.loadTrialsFromCSV();
            console.log(`Loaded ${trialsData.length} trials from CSV`);
            
            // Simple random selection with no duplicates within the experiment
            const shuffledTrials = this.shuffle([...trialsData]);
            
            // Select trials for main experiment (ensuring no duplicates)
            const mainTrialCount = Math.min(this.experimentConfig.mainTrials, shuffledTrials.length);
            const selectedMainTrials = shuffledTrials.slice(0, mainTrialCount);
            
            // Select practice trials from remaining trials (or from a separate shuffle)
            const practiceTrialCount = this.experimentConfig.practiceTrials;
            const remainingTrials = shuffledTrials.slice(mainTrialCount);
            let selectedPracticeTrials;
            
            if (remainingTrials.length >= practiceTrialCount) {
                // Use remaining trials for practice
                selectedPracticeTrials = remainingTrials.slice(0, practiceTrialCount);
            } else {
                // Not enough remaining - shuffle again for practice (overlap okay)
                const practicePool = this.shuffle([...trialsData]);
                selectedPracticeTrials = practicePool.slice(0, practiceTrialCount);
            }
            
            // Create practice trials
            this.practiceTrials = selectedPracticeTrials.map((trial, i) => ({
                trial_number: `practice_${i + 1}`,
                risk_probability: trial.risk_probability,
                risk_reward: trial.risk_reward,
                safe_reward: trial.safe_reward,
                size_condition: trial.size_condition,
                risk_on_left: Math.random() < 0.5,
                is_practice: true,
                combination_id: trial.combination_id,
                expected_value: trial.expected_value,
                trial_id: trial.trial_id
            }));

            // Create main trials
            this.trials = selectedMainTrials.map((trial, i) => ({
                trial_number: i + 1,
                risk_probability: trial.risk_probability,
                risk_reward: trial.risk_reward,
                safe_reward: trial.safe_reward,
                size_condition: trial.size_condition,
                risk_on_left: Math.random() < 0.5,
                is_practice: false,
                combination_id: trial.combination_id,
                expected_value: trial.expected_value,
                trial_id: trial.trial_id
            }));

            // Select and intersperse attention checks (only if they exist and are requested)
            this.finalTimeline = [...this.trials];
            
            if (this.attentionCheckQuestions && 
                this.attentionCheckQuestions.length > 0 && 
                this.experimentConfig.attentionChecks > 0) {
                
                const selectedAttentionChecks = this.shuffle([...this.attentionCheckQuestions])
                    .slice(0, this.experimentConfig.attentionChecks);
                
                this.attentionChecks = selectedAttentionChecks.map(q => ({ ...q, is_attention: true }));
                
                if (this.attentionChecks.length > 0 && this.trials.length > 0) {
                    const interval = Math.floor(this.trials.length / (this.attentionChecks.length + 1));
                    let insertedCount = 0;
                    
                    for (let i = 0; i < this.attentionChecks.length; i++) {
                        const insertPosition = (i + 1) * interval + insertedCount;
                        if (insertPosition < this.finalTimeline.length) {
                            this.finalTimeline.splice(insertPosition, 0, this.attentionChecks[i]);
                            insertedCount++;
                        } else {
                            this.finalTimeline.push(this.attentionChecks[i]);
                        }
                    }
                }
            }
            
            console.log(`Generated ${this.practiceTrials.length} practice trials and ${this.trials.length} main trials`);
            
        } catch (error) {
            console.error("Error loading trials from CSV:", error);
            // Fall back to old generation method if CSV loading fails
            this.generateTrialsOldMethod();
        }
    }

    async loadTrialsFromCSV() {
        const response = await fetch('full_trials.csv');
        if (!response.ok) {
            throw new Error(`Failed to load trials CSV: ${response.status}`);
        }
        
        const csvText = await response.text();
        const lines = csvText.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
            throw new Error('CSV file appears to be empty or malformed');
        }
        
        const headers = lines[0].split(',');
        const trials = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const trial = {};
            
            headers.forEach((header, index) => {
                const value = values[index];
                // Convert numeric fields
                if (['trial_id', 'combination_id', 'risk_probability', 'risk_reward', 'safe_reward', 'expected_value'].includes(header)) {
                    trial[header] = parseInt(value);
                } else {
                    trial[header] = value;
                }
            });
            
            trials.push(trial);
        }
        
        return trials;
    }

    generateTrialsOldMethod() {
        // Fallback method - original trial generation
        console.log("Using fallback trial generation method");
        
        const combinations = [];
        const riskProbs = [25, 50, 75];
        const riskRewards = [100, 200, 300];
        const safeRewards = [50, 100, 150];

        for (let p of riskProbs) {
            for (let rr of riskRewards) {
                for (let sr of safeRewards) {
                    combinations.push({
                        riskProbability: p,
                        riskReward: rr,
                        safeReward: sr,
                    });
                }
            }
        }

        // Generate practice trials
        const sizeConditions = ['both-large', 'both-small', 'risk-large', 'safe-large'];
        const shuffledForPractice = this.shuffle([...combinations]).slice(0, this.experimentConfig.practiceTrials);
        
        this.practiceTrials = shuffledForPractice.map((combo, i) => ({
            trial_number: `practice_${i + 1}`,
            risk_probability: combo.riskProbability,
            risk_reward: combo.riskReward,
            safe_reward: combo.safeReward,
            size_condition: sizeConditions[Math.floor(Math.random() * sizeConditions.length)],
            risk_on_left: Math.random() < 0.5,
            is_practice: true
        }));

        // Generate main trials
        const shuffledForMain = this.shuffle([...combinations]).slice(0, this.experimentConfig.mainTrials);
        
        this.trials = shuffledForMain.map((combo, i) => ({
            trial_number: i + 1,
            risk_probability: combo.riskProbability,
            risk_reward: combo.riskReward,
            safe_reward: combo.safeReward,
            size_condition: sizeConditions[Math.floor(Math.random() * sizeConditions.length)],
            risk_on_left: Math.random() < 0.5,
            is_practice: false
        }));

        // Select and intersperse attention checks (only if they exist and are requested)
        this.finalTimeline = [...this.trials];
        
        if (this.attentionCheckQuestions && 
            this.attentionCheckQuestions.length > 0 && 
            this.experimentConfig.attentionChecks > 0) {
            
            const selectedAttentionChecks = this.shuffle([...this.attentionCheckQuestions])
                .slice(0, this.experimentConfig.attentionChecks);
            
            this.attentionChecks = selectedAttentionChecks.map(q => ({ ...q, is_attention: true }));
            
            if (this.attentionChecks.length > 0 && this.trials.length > 0) {
                const interval = Math.floor(this.trials.length / (this.attentionChecks.length + 1));
                let insertedCount = 0;
                
                for (let i = 0; i < this.attentionChecks.length; i++) {
                    const insertPosition = (i + 1) * interval + insertedCount;
                    if (insertPosition < this.finalTimeline.length) {
                        this.finalTimeline.splice(insertPosition, 0, this.attentionChecks[i]);
                        insertedCount++;
                    } else {
                        this.finalTimeline.push(this.attentionChecks[i]);
                    }
                }
            }
        }
    }

    shuffle(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    startPractice() {
        this.currentTrialIndex = 0;
        this.isPractice = true;
        this.currentTimeline = this.practiceTrials;
        this.runNextTrial();
    }

    startMainTrials() {
        document.body.innerHTML = `
            <div class="main-container">
                <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: var(--text-primary); margin-bottom: 1.5rem;">üéâ Practice Complete!</h2>
                    <p style="font-size: 18px; color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                        Great! You're now ready for the main experiment.
                    </p>
                    <div style="background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
                        <h3 style="margin-top: 0; color: #2d5a2d;">üìä What's Next</h3>
                        <ul style="margin-bottom: 0; color: #2d5a2d; line-height: 1.5; text-align: left;">
                            <li><strong>72 decision trials</strong> with varying risk levels</li>
                            <li><strong>8-second timer</strong> for each choice</li>
                        </ul>
                    </div>
                    <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 2rem;">
                        The screen will go fullscreen for the main experiment.
                    </p>
                <div class="navigation">
                        <button class="next-button" onclick="experiment.beginMainTrials()">Begin</button>
                    </div>
                </div>
            </div>
        `;
    }

    beginMainTrials() {
        // Request fullscreen
                if (document.fullscreenElement === null) {
            document.documentElement.requestFullscreen().then(() => {
                this.currentTrialIndex = 0;
                this.isPractice = false;
                this.currentTimeline = this.finalTimeline;
                this.runNextTrial();
            });
        } else {
            this.currentTrialIndex = 0;
            this.isPractice = false;
            this.currentTimeline = this.finalTimeline;
            this.runNextTrial();
        }
    }

    // ================================
    // TRIAL EXECUTION & USER INTERACTION
    // ================================

    runNextTrial() {
        if (this.currentTrialIndex >= this.currentTimeline.length) {
            if (this.isPractice) {
                this.startMainTrials();
            } else {
                this.finishExperiment();
            }
            return;
        }

        const trial = this.currentTimeline[this.currentTrialIndex];
        
        if (trial.is_attention) {
            this.runAttentionCheck(trial);
        } else {
            this.runMainTrial(trial);
        }
    }

    runMainTrial(trial) {
        this.clearTimer();
        this.resetTrialState();

        const totalTrials = this.isPractice ? this.practiceTrials.length : this.trials.length;
        const trialHTML = this.createTrialHTML(trial, totalTrials);
        
        document.body.innerHTML = `<div class="main-container trial-container-page">${trialHTML}</div>`;

        // Start timer for main trials (not practice)
        if (!this.isPractice) {
            this.startTrialTimer();
        }
    }

    runAttentionCheck(question) {
         this.clearTimer();
         
         let stimulus;
         switch (question.type) {
             case 'multi-choice':
                 stimulus = `
                     <div class="attention-check-container">
                         <div class="attention-check-prompt">${question.prompt}</div>
                         <div class="attention-check-options">
                             ${question.options.map((option, index) => `
                                 <label class="attention-check-option">
                                     <input type="radio" name="attention-choice" value="${option}" data-index="${index}">
                                     <span>${option}</span>
                                 </label>
                             `).join('')}
                         </div>
                         <div class="attention-warning" id="attention-warning" style="color: red; font-weight: bold; margin-top: 10px; visibility: hidden;"></div>
                         <div class="navigation" style="margin-top: 20px;">
                             <button id="attention-next-btn" class="next-button" disabled>Next</button>
                         </div>
                     </div>
                 `;
                 break;
                 
             case 'text':
                 stimulus = `
                     <div class="attention-check-container">
                         <div class="attention-check-prompt">${question.prompt}</div>
                         <div class="attention-check-input">
                             <input type="text" id="attention-text-input" placeholder="Type your answer here..." style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px;">
                         </div>
                         <div class="attention-warning" id="attention-warning" style="color: red; font-weight: bold; margin-top: 10px; visibility: hidden;"></div>
                         <div class="navigation" style="margin-top: 20px;">
                             <button id="attention-next-btn" class="next-button" disabled>Next</button>
                         </div>
                     </div>
                 `;
                 break;
                 
             case 'likert':
                 stimulus = `
                     <div class="attention-check-container">
                         <div class="attention-check-prompt">${question.prompt}</div>
                         <div class="attention-check-likert">
                             ${question.labels.map((label, index) => `
                                 <label class="attention-check-option">
                                     <input type="radio" name="attention-likert" value="${index}" data-label="${label}">
                                     <span>${label}</span>
                                 </label>
                             `).join('')}
                         </div>
                         <div class="attention-warning" id="attention-warning" style="color: red; font-weight: bold; margin-top: 10px; visibility: hidden;"></div>
                         <div class="navigation" style="margin-top: 20px;">
                             <button id="attention-next-btn" class="next-button" disabled>Next</button>
                         </div>
                     </div>
                 `;
                 break;
         }

         document.body.innerHTML = `<div class="main-container attention-check-page">${stimulus}</div>`;
         this.setupAttentionCheckEvents(question);
    }

    setupAttentionCheckEvents(question) {
        const nextBtn = document.getElementById('attention-next-btn');
        const warning = document.getElementById('attention-warning');

        if (question.type === 'multi-choice') {
            const radios = document.querySelectorAll('input[name="attention-choice"]');
            
            radios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === question.correct_answer) {
                        nextBtn.disabled = false;
                        warning.style.visibility = 'hidden';
                    } else {
                        nextBtn.disabled = true;
                        warning.style.visibility = 'visible';
                        warning.textContent = 'Are you paying attention? Please select the correct answer to continue.';
                    }
                });
            });
            
        } else if (question.type === 'text') {
            const textInput = document.getElementById('attention-text-input');
            
            textInput.addEventListener('input', () => {
                const userInput = textInput.value.trim().toLowerCase();
                const correctAnswer = question.correct_answer.toLowerCase();
                
                if (userInput === correctAnswer) {
                    nextBtn.disabled = false;
                    warning.style.visibility = 'hidden';
                } else {
                    nextBtn.disabled = true;
                    warning.style.visibility = 'visible';
                    warning.textContent = 'Are you paying attention? Please type the correct answer to continue.';
                }
            });
            
        } else if (question.type === 'likert') {
            const radios = document.querySelectorAll('input[name="attention-likert"]');
            
            radios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const selectedLabel = radio.getAttribute('data-label');
                    if (selectedLabel === question.correct_answer) {
                        nextBtn.disabled = false;
                        warning.style.visibility = 'hidden';
                    } else {
                        nextBtn.disabled = true;
                        warning.style.visibility = 'visible';
                        warning.textContent = 'Are you paying attention? Please select the correct answer to continue.';
                    }
                });
            });
        }

        nextBtn.addEventListener('click', () => {
            if (!nextBtn.disabled) {
                this.currentTrialIndex++;
                this.runNextTrial();
            }
        });
    }

    createTrialHTML(trial, totalTrials) {
        const riskBarHTML = `
            <div class="option">
                <div class="option-label option-label-top">${trial.risk_reward}</div>
                <div class="risk-bar ${this.getSizeClass(trial.size_condition, 'risk')} selectable-bar" id="risk-bar" onclick="experiment.selectChoice('risk')">
                    <div class="risk-bar-red" style="height: ${trial.risk_probability}%;">
                        ${trial.risk_probability}%
                    </div>
                    <div class="risk-bar-blue" style="height: ${100 - trial.risk_probability}%;">
                        ${100 - trial.risk_probability}%
                    </div>
                </div>
                <div class="option-label option-label-bottom">0</div>
            </div>`;

        const safeBarHTML = `
            <div class="option">
                <div class="option-label option-label-top">${trial.safe_reward}</div>
                <div class="safe-bar ${this.getSizeClass(trial.size_condition, 'safe')} selectable-bar" id="safe-bar" onclick="experiment.selectChoice('safe')">
                    100%
                </div>
                <div class="option-label option-label-bottom" style="visibility: hidden;">0</div>
            </div>`;

        const leftOption = trial.risk_on_left ? riskBarHTML : safeBarHTML;
        const rightOption = trial.risk_on_left ? safeBarHTML : riskBarHTML;

        const trialCounterText = this.isPractice ? 
            `Practice ${trial.trial_number.replace('practice_', '')}` : 
            `Trial ${trial.trial_number} of ${totalTrials}`;

        return `
            <div class="trial-header">
                <div id="trial-counter">${trialCounterText}</div>
                <div id="trial-timer">${!this.isPractice ? 'Time left: 8s' : ''}</div>
            </div>
            <div class="bars-area">
                <div class="option-container">${leftOption}</div>
                <div class="option-container">${rightOption}</div>
            </div>
            <div class="confidence-container">
                <div class="confidence-label" id="confidence-label">On a scale of 0‚Äì100, how confident are you in your choice?</div>
                <input type="range" class="confidence-slider" id="confidence-slider" min="0" max="100" value="50" oninput="experiment.updateConfidence(this.value)" disabled>
                <div class="confidence-value" id="confidence-value">50</div>
            </div>
            <div class="navigation">
                <button class="next-button" id="next-button" onclick="experiment.advanceTrial()" disabled>Next</button>
            </div>`;
    }

    getSizeClass(sizeCondition, optionType) {
        switch (sizeCondition) {
            case 'both-large': return 'size-large';
            case 'both-small': return 'size-small';
            case 'risk-large': return optionType === 'risk' ? 'size-large' : 'size-small';
            case 'safe-large': return optionType === 'safe' ? 'size-large' : 'size-small';
            default: return 'size-large';
        }
    }

    resetTrialState() {
        this.currentChoice = null;
        this.currentConfidence = null;
        this.trialStartTime = Date.now();
        this.pageEntryTime = (Date.now() - this.trialStartTime) / 1000; // Set immediately when page loads
        this.barChoiceTime = null;
        this.sliderInteracted = false;
    }

    startTrialTimer() {
        let timeLeft = this.experimentConfig.trialDuration / 1000;
        const timerElement = document.getElementById('trial-timer');

        if (timerElement) {
            timerElement.textContent = `Time left: ${timeLeft}s`;
        }

        this.currentTimer = setInterval(() => {
            timeLeft--;
            if (timerElement) {
                timerElement.textContent = `Time left: ${timeLeft}s`;
            }
            if (timeLeft <= 0) {
                this.clearTimer();
                this.finishTrial();
            }
        }, 1000);
    }

    clearTimer() {
        if (this.currentTimer) {
            clearInterval(this.currentTimer);
            this.currentTimer = null;
        }
    }

    selectChoice(choice) {
        const time = (Date.now() - this.trialStartTime) / 1000;
        this.barChoiceTime = time; // Record when choice was made

        this.currentChoice = choice;
        document.querySelectorAll('.selectable-bar').forEach(bar => {
            bar.classList.remove('selected-bar');
        });
        const selectedElement = document.getElementById(choice === 'risk' ? 'risk-bar' : 'safe-bar');
        if (selectedElement) {
            selectedElement.classList.add('selected-bar');
        }
        
        // Enable the confidence slider after bar selection
        const confidenceSlider = document.getElementById('confidence-slider');
        const confidenceLabel = document.getElementById('confidence-label');
        if (confidenceSlider) {
            confidenceSlider.disabled = false;
        }
        if (confidenceLabel) {
            confidenceLabel.textContent = 'On a scale of 0‚Äì100, how confident are you in your choice?';
        }
        
        this.checkTrialComplete();
    }

    updateConfidence(value) {
        // Only allow updating if a choice has been made
        if (this.currentChoice === null) {
            return;
        }
        
        this.currentConfidence = parseInt(value);
        this.sliderInteracted = true;
        const confidenceValueElement = document.getElementById('confidence-value');
        if (confidenceValueElement) {
            confidenceValueElement.textContent = value;
        }
        this.checkTrialComplete();
    }

    checkTrialComplete() {
        const nextButton = document.getElementById('next-button');
        if (nextButton && this.currentChoice !== null && this.sliderInteracted) {
            nextButton.disabled = false;
        } else if (nextButton) {
            nextButton.disabled = true;
        }
    }

    advanceTrial() {
        this.finishTrial();
    }

    finishTrial() {
        this.clearTimer();
        
        if (!this.isPractice) {
            const trial = this.currentTimeline[this.currentTrialIndex];
            if (!trial.is_attention) {
                this.saveTrialData(trial);
            }
        }
        
        this.currentTrialIndex++;
        this.runNextTrial();
    }

    // ================================
    // DATA COLLECTION & EXPORT
    // ================================

    saveTrialData(trial) {
        const submitTime = (Date.now() - this.trialStartTime) / 1000;
        
        // Ensure choice is a proper string value
        let choiceValue = 'timeout'; // Default if no choice made
        if (this.currentChoice === 'risk' || this.currentChoice === 'safe') {
            choiceValue = this.currentChoice;
        }
        
        // Set confidence to NaN if slider wasn't interacted with
        let confidenceValue = this.sliderInteracted && this.currentConfidence !== null ? this.currentConfidence : NaN;
        
        // Calculate intuitive timing metrics
        const bar_choice_time = this.barChoiceTime || NaN; // Time from page load to bar choice
        const confidence_choice_time = (this.barChoiceTime && submitTime) ? (submitTime - this.barChoiceTime) : NaN; // Time from bar choice to confidence
        
        // Determine positions
        const riskPosition = trial.risk_on_left ? 'left' : 'right';
        const safePosition = trial.risk_on_left ? 'right' : 'left';
        
        // Calculate expected value comparison
        const riskEV = (trial.risk_probability / 100) * trial.risk_reward;
        const safeEV = trial.safe_reward;
        let ev;
        if (Math.abs(riskEV - safeEV) < 0.01) { // essentially equal
            ev = 'same';
        } else if (safeEV > riskEV) {
            ev = 'safe';
        } else {
            ev = 'risky';
        }
        
        // Create clean CSV row with intuitive field names
        const row = [
            this.subjectId || 'unknown',           // participant_id
            this.trialCounter++,                   // trial_number  
            trial.size_condition || 'unknown',    // bar_size_condition
            choiceValue,                           // choice (risk/safe/timeout)
            confidenceValue,                       // confidence (0-100 or NaN)
            trial.risk_probability || 0,          // risk_probability
            trial.risk_reward || 0,               // risk_reward  
            100,                                   // safe_probability (always 100%)
            trial.safe_reward || 0,               // safe_reward
            riskPosition,                          // risk_position (left/right)
            safePosition,                          // safe_position (left/right)
            ev,                                    // ev (same/safe/risky)
            bar_choice_time,                       // bar_choice_time (seconds from page load to bar choice)
            confidence_choice_time,                // confidence_choice_time (seconds from bar choice to confidence)
            trial.trial_id || 'unknown'           // trial_id
        ];
        
        // Properly escape CSV fields
        const escapedRow = row.map(field => {
            const str = String(field);
            // If field contains comma, newline, or quote, wrap in quotes and escape internal quotes
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }).join(',') + '\n';
        
        this.csvData.push(escapedRow);
        
        // Debug logging with clearer format
        console.log(`Trial ${this.trialCounter - 1}: choice="${choiceValue}", confidence=${confidenceValue}, ev=${ev}, bar_choice_time=${bar_choice_time}s, confidence_time=${confidence_choice_time}s`);
    }

    async finishExperiment() {
        // Validate data before attempting to save
        if (!this.csvData || this.csvData.length === 0) {
            console.error('No data to save!');
            this.showDataError('No trial data was collected. Please contact the researcher.');
            return;
        }

        if (!this.subjectId) {
            console.error('No subject ID!');
            this.showDataError('Subject ID is missing. Please contact the researcher.');
            return;
        }

        document.body.innerHTML = `
            <div class="main-container">
                <div class="instructions">
                    <h2>Completing the experiment...</h2>
                    <p>Please wait while your data is being saved.</p>
                    <div style="margin-top: 1rem; color: #666;">
                        <small>Saving ${this.csvData.length} trial records for subject ${this.subjectId}...</small>
                    </div>
                </div>
            </div>`;

        try {
            console.log(`Attempting to save ${this.csvData.length} trials for subject ${this.subjectId}`);
            console.log('Sample data row:', this.csvData[0]);

            const response = await fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ data: this.csvData.join('') }),
            });

            const responseText = await response.text();
            console.log('Server response:', responseText);

            if (response.ok) {
                document.body.innerHTML = `
                    <div class="main-container">
                        <div class="instructions">
                            <h2>Thank You</h2>
                            <div style="border: 1px solid #e5e5e5; padding: 2rem; border-radius: 4px; margin: 2rem 0; background: #fafafa;">
                                <p style="font-size: 18px; margin-bottom: 1rem;">You have successfully completed the risk survey task.</p>
                                <p style="color: green; font-weight: bold;">Your responses have been successfully saved.</p>
                                <div style="margin-top: 1rem; color: #666; font-size: 14px;">
                                    <small>Subject ID: ${this.subjectId} | Trials completed: ${this.csvData.length}</small>
                                </div>
                            </div>
                            <p>You may now close this window.</p>
                        </div>
                    </div>`;
            } else {
                throw new Error(`Server error: ${response.status} - ${responseText}`);
            }
        } catch (err) {
            console.error('Error saving data:', err);
            this.showDataError(`There was an error saving your data: ${err.message}`);
        }
    }

    showDataError(message) {
        document.body.innerHTML = `
            <div class="main-container">
                <div class="instructions">
                    <h2>Data Save Error</h2>
                    <div style="border: 1px solid #e5e5e5; padding: 2rem; border-radius: 4px; margin: 2rem 0; background: #fff2f2; color: #d32f2f; border-left: 4px solid #d32f2f;">
                        <p style="font-weight: bold; margin-bottom: 1rem;">‚ö†Ô∏è Unable to save your data</p>
                        <p>${message}</p>
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                            <p style="font-weight: bold; margin-bottom: 0.5rem;">Debug Information:</p>
                            <p style="font-size: 12px; font-family: monospace; margin: 0;">
                                Subject ID: ${this.subjectId || 'MISSING'}<br>
                                Trials collected: ${this.csvData?.length || 0}<br>
                                Timestamp: ${new Date().toISOString()}
                            </p>
                        </div>
                    </div>
                    <p>Please screenshot this message and contact the researcher immediately.</p>
                </div>
            </div>`;
    }
}

// initialize experiment when page loads
const experiment = new RiskSurveyExperiment();
document.addEventListener('DOMContentLoaded', () => {
    experiment.init();
}); 